<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      #bpmn-editor-container {
        height: calc(100vh - 50px);
      }

      .toolbar {
        height: 30px;
      }

      .hidden {
        display: none;
      }
    </style>

    <title></title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="kogito-editors-0.15.0.js"></script>
    <script src="lienzo-svg-tiger.js"></script>
  </head>
  <body>
    <div class="toolbar">
      <button id="reset">Reset</button>
      <button id="logNodes">Log Nodes</button>
      <button id="runtimeUIButton">Runtime UI</button>
      <button id="focusOnTask">Focus On Task</button>
      <button id="createTiger">Create Tiger</button>
    </div>
    <div id="bpmn-editor-container" />

    <script>
      const bpmnRaw = "<bpmn2:definitions xmlns:bpmn2=\"http://www.omg.org/spec/BPMN/20100524/MODEL\" xmlns:bpmndi=\"http://www.omg.org/spec/BPMN/20100524/DI\" xmlns:bpsim=\"http://www.bpsim.org/schemas/1.0\" xmlns:dc=\"http://www.omg.org/spec/DD/20100524/DC\" xmlns:di=\"http://www.omg.org/spec/DD/20100524/DI\" xmlns:drools=\"http://www.jboss.org/drools\" xmlns:xsi=\"xsi\" id=\"_NlePUDUoEDqFboGcmIdcaQ\" xsi:schemaLocation=\"http://www.omg.org/spec/BPMN/20100524/MODEL BPMN20.xsd http://www.jboss.org/drools drools.xsd http://www.bpsim.org/schemas/1.0 bpsim.xsd http://www.omg.org/spec/DD/20100524/DC DC.xsd http://www.omg.org/spec/DD/20100524/DI DI.xsd \" exporter=\"jBPM Process Modeler\" exporterVersion=\"2.0\" targetNamespace=\"http://www.omg.org/bpmn20\">\n" +
              "  <bpmn2:process id=\"Untitled\" drools:packageName=\"com.example\" drools:version=\"1.0\" drools:adHoc=\"false\" name=\"Untitled\" isExecutable=\"true\" processType=\"Public\">\n" +
              "    <bpmn2:sequenceFlow id=\"_DCC6B634-2FAA-4D90-BCFE-23E9711F7706\" sourceRef=\"_316B6615-F68E-4FD4-9A58-BF39FEE32D9E\" targetRef=\"_2A444B42-DA8D-442B-8306-898E49F56E08\"/>\n" +
              "    <bpmn2:sequenceFlow id=\"_602FB3FE-A013-4A2C-ABE0-9235BB9AFF5D\" sourceRef=\"_99E06288-F486-4B31-B170-556C0938FD8B\" targetRef=\"_316B6615-F68E-4FD4-9A58-BF39FEE32D9E\"/>\n" +
              "    <bpmn2:endEvent id=\"_2A444B42-DA8D-442B-8306-898E49F56E08\">\n" +
              "      <bpmn2:incoming>_DCC6B634-2FAA-4D90-BCFE-23E9711F7706</bpmn2:incoming>\n" +
              "    </bpmn2:endEvent>\n" +
              "    <bpmn2:task id=\"_316B6615-F68E-4FD4-9A58-BF39FEE32D9E\" name=\"Task1\">\n" +
              "      <bpmn2:extensionElements>\n" +
              "        <drools:metaData name=\"elementname\">\n" +
              "          <drools:metaValue><![CDATA[Task1]]></drools:metaValue>\n" +
              "        </drools:metaData>\n" +
              "      </bpmn2:extensionElements>\n" +
              "      <bpmn2:incoming>_602FB3FE-A013-4A2C-ABE0-9235BB9AFF5D</bpmn2:incoming>\n" +
              "      <bpmn2:outgoing>_DCC6B634-2FAA-4D90-BCFE-23E9711F7706</bpmn2:outgoing>\n" +
              "    </bpmn2:task>\n" +
              "    <bpmn2:startEvent id=\"_99E06288-F486-4B31-B170-556C0938FD8B\">\n" +
              "      <bpmn2:outgoing>_602FB3FE-A013-4A2C-ABE0-9235BB9AFF5D</bpmn2:outgoing>\n" +
              "    </bpmn2:startEvent>\n" +
              "  </bpmn2:process>\n" +
              "  <bpmndi:BPMNDiagram>\n" +
              "    <bpmndi:BPMNPlane bpmnElement=\"Untitled\">\n" +
              "      <bpmndi:BPMNShape id=\"shape__99E06288-F486-4B31-B170-556C0938FD8B\" bpmnElement=\"_99E06288-F486-4B31-B170-556C0938FD8B\">\n" +
              "        <dc:Bounds height=\"56\" width=\"56\" x=\"257\" y=\"169\"/>\n" +
              "      </bpmndi:BPMNShape>\n" +
              "      <bpmndi:BPMNShape id=\"shape__316B6615-F68E-4FD4-9A58-BF39FEE32D9E\" bpmnElement=\"_316B6615-F68E-4FD4-9A58-BF39FEE32D9E\">\n" +
              "        <dc:Bounds height=\"102\" width=\"154\" x=\"393\" y=\"146\"/>\n" +
              "      </bpmndi:BPMNShape>\n" +
              "      <bpmndi:BPMNShape id=\"shape__2A444B42-DA8D-442B-8306-898E49F56E08\" bpmnElement=\"_2A444B42-DA8D-442B-8306-898E49F56E08\">\n" +
              "        <dc:Bounds height=\"56\" width=\"56\" x=\"627\" y=\"169\"/>\n" +
              "      </bpmndi:BPMNShape>\n" +
              "      <bpmndi:BPMNEdge id=\"edge_shape__99E06288-F486-4B31-B170-556C0938FD8B_to_shape__316B6615-F68E-4FD4-9A58-BF39FEE32D9E\" bpmnElement=\"_602FB3FE-A013-4A2C-ABE0-9235BB9AFF5D\">\n" +
              "        <di:waypoint x=\"285\" y=\"197\"/>\n" +
              "        <di:waypoint x=\"470\" y=\"197\"/>\n" +
              "      </bpmndi:BPMNEdge>\n" +
              "      <bpmndi:BPMNEdge id=\"edge_shape__316B6615-F68E-4FD4-9A58-BF39FEE32D9E_to_shape__2A444B42-DA8D-442B-8306-898E49F56E08\" bpmnElement=\"_DCC6B634-2FAA-4D90-BCFE-23E9711F7706\">\n" +
              "        <di:waypoint x=\"470\" y=\"197\"/>\n" +
              "        <di:waypoint x=\"655\" y=\"197\"/>\n" +
              "      </bpmndi:BPMNEdge>\n" +
              "    </bpmndi:BPMNPlane>\n" +
              "  </bpmndi:BPMNDiagram>\n" +
              "  <bpmn2:relationship type=\"BPSimData\">\n" +
              "    <bpmn2:extensionElements>\n" +
              "      <bpsim:BPSimData>\n" +
              "        <bpsim:Scenario id=\"default\" name=\"Simulationscenario\">\n" +
              "          <bpsim:ScenarioParameters/>\n" +
              "          <bpsim:ElementParameters elementRef=\"_99E06288-F486-4B31-B170-556C0938FD8B\">\n" +
              "            <bpsim:TimeParameters>\n" +
              "              <bpsim:ProcessingTime>\n" +
              "                <bpsim:NormalDistribution mean=\"0\" standardDeviation=\"0\"/>\n" +
              "              </bpsim:ProcessingTime>\n" +
              "            </bpsim:TimeParameters>\n" +
              "          </bpsim:ElementParameters>\n" +
              "          <bpsim:ElementParameters elementRef=\"_316B6615-F68E-4FD4-9A58-BF39FEE32D9E\">\n" +
              "            <bpsim:TimeParameters>\n" +
              "              <bpsim:ProcessingTime>\n" +
              "                <bpsim:NormalDistribution mean=\"0\" standardDeviation=\"0\"/>\n" +
              "              </bpsim:ProcessingTime>\n" +
              "            </bpsim:TimeParameters>\n" +
              "            <bpsim:ResourceParameters>\n" +
              "              <bpsim:Availability>\n" +
              "                <bpsim:FloatingParameter value=\"0\"/>\n" +
              "              </bpsim:Availability>\n" +
              "              <bpsim:Quantity>\n" +
              "                <bpsim:FloatingParameter value=\"0\"/>\n" +
              "              </bpsim:Quantity>\n" +
              "            </bpsim:ResourceParameters>\n" +
              "            <bpsim:CostParameters>\n" +
              "              <bpsim:UnitCost>\n" +
              "                <bpsim:FloatingParameter value=\"0\"/>\n" +
              "              </bpsim:UnitCost>\n" +
              "            </bpsim:CostParameters>\n" +
              "          </bpsim:ElementParameters>\n" +
              "        </bpsim:Scenario>\n" +
              "      </bpsim:BPSimData>\n" +
              "    </bpmn2:extensionElements>\n" +
              "    <bpmn2:source>_NlePUDUoEDqFboGcmIdcaQ</bpmn2:source>\n" +
              "    <bpmn2:target>_NlePUDUoEDqFboGcmIdcaQ</bpmn2:target>\n" +
              "  </bpmn2:relationship>\n" +
              "</bpmn2:definitions>";
      const startEventId = "_99E06288-F486-4B31-B170-556C0938FD8B";
      const taskId = "_316B6615-F68E-4FD4-9A58-BF39FEE32D9E";
      const endEventId = "_2A444B42-DA8D-442B-8306-898E49F56E08";

      let editor = createBpmnEditor();

      document.getElementById("reset").addEventListener("click", () => {
        reset();
      });

      document.getElementById("logNodes").addEventListener("click", () => {
        editor.canvas.getNodeIds().then(ids => {
          window.console.log("IDS = " + ids);
        });
      });

      document.getElementById("runtimeUIButton").addEventListener("click", () => {
        setNodeDisabled(startEventId);
        setNodeDisabled(taskId);
        setNodeDisabled(endEventId);
        showBadge(startEventId, '17');
        showBadge(taskId, '27');
        showBadge(endEventId, '37');
      });

      document.getElementById("focusOnTask").addEventListener("click", () => {
        focusOnNode(taskId);
      });

      document.getElementById("createTiger").addEventListener("click", () => {
        createSVGTigerGroup();
      });

      function focusOnNode(shapeId) {
        let editorframe = window.frames[0];
        let editorcanvas = editorframe.canvas;
        let shape = editorcanvas.getWiresShape(shapeId);
        var location = shape.getComputedLocation();
        var bb = shape.getBoundingBox();

        var ev = editorcanvas.getViewport();
        var vt = ev.transform;
        var sx = vt.getScaleX();
        var sy = vt.getScaleY();
        console.log("SX = " + sx);
        console.log("SY = " + sy);
        vt.scale(2);
        editorcanvas.draw();
      }

      function setNodeDisabled(shapeId) {
        editor.canvas.setBackgroundColor(shapeId, "#C0C0C0");
        editor.canvas.setBorderColor(shapeId, "black");
      }

      const animationDuration = 500;

      function showBadge(shapeId, badgeText) {
        let editorframe = window.frames[0];
        let editorcanvas = editorframe.canvas;
        let shape = editorcanvas.getWiresShape(shapeId);
        var location = shape.getComputedLocation();
        var bb = shape.getBoundingBox();
        var badge = createBadge(badgeText);
        var bx = badge.x + location.x + (bb.getWidth() / 2);
        var by = badge.y + location.y + bb.getHeight();
        badge.alpha = 0;
        badge.listening = false;
        badge.x = 0;
        badge.y = 0;
        editorcanvas.add(badge);
        editorcanvas.draw();
        editorcanvas.animations().alpha(badge, 1, animationDuration);
        editorcanvas.animations().x(badge, bx, animationDuration);
        editorcanvas.animations().y(badge, by, animationDuration);
      }

      function createBadge(badgetext) {
        let editorframe = window.frames[0];
        let shapes = editorframe.com.ait.lienzo.client.core.shape;
        var text = new shapes.Text(badgetext, "Open Sans", "normal", 10);
        text.strokeColor = 'white';
        text.fillColor = 'white';
        var bb = text.getBoundingBox();
        var bbw = bb.getWidth() + 10;
        var bbh = bb.getHeight() + 10;
        var decorator = new shapes.Rectangle(bbw, bbh);
        decorator.x = bb.getX() - 5;
        decorator.y = bb.getY() - 5;
        decorator.fillAlpha = 0.5;
        decorator.strokeAlpha = 0;
        decorator.strokeColor = 'black';
        decorator.fillColor = 'C0C0C0';
        decorator.strokeWitrh = 2;
        decorator.cornerRadius = 5;
        var badge = new shapes.Group();
        badge.add(decorator);
        badge.add(text);
        badge.x = -(bbw / 2) + 5;
        badge.y = (bbh / 2) + 5;
        return badge;
      }

      function createSVGTigerGroup() {
        let editorframe = window.frames[0];
        let editorcanvas = editorframe.canvas;
        let shapes = editorframe.com.ait.lienzo.client.core.shape;
        var tiger = buildTigerGroup(shapes);
        var tx = 350;
        var ty = 450;
        tiger.x = 0;
        tiger.y = ty;
        tiger.alpha = 0;
        tiger.draggable = true;
        editorcanvas.add(tiger);
        editorcanvas.draw();
        editorcanvas.animations().alpha(tiger, 1, animationDuration);
        editorcanvas.animations().x(tiger, tx, animationDuration / 2);
        editorcanvas.animations().y(tiger, ty, animationDuration / 2);
      }

      function reset() {
        editor.close();
        editor = createBpmnEditor();
      }

      function createBpmnEditor() {
        return BpmnEditor.open({
          container: document.getElementById("bpmn-editor-container"),
          initialContent: Promise.resolve(bpmnRaw),
          readOnly: true
        });
      }

    </script>
  </body>
</html>
